<!DOCTYPE html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.0.13/Tone.min.js"></script>
<script> 


//use this to determine which chanel an input comes from 

//http://computermusicresource.com/MIDI.Commands.html?source=post_page---------------------------
const ON_CHANNELS = {
    "144": "1",
    "145": "2",
    "146": "3",
    "147": "4",
    "148": "5",
    "149": "6",
    "150": "7",
    "151": "8",
    "152": "9",
    "153": "10",
    "154": "11",
    "155": "12",
    "156": "13",
    "157": "14",
    "158": "15",
    "159": "16"
}

const OFF_CHANNELS = {
    '128': '1',
    '129': '2',
    '130': '3',
    '131': '4',
    '132': '5',
    '133': '6',
    '134': '7',
    '135': '8',
    '136': '9',
    '137': '10',
    '138': '11',
    '139': '12',
    '140': '13',
    '141': '14',
    '142': '15',
    '143': '16'
}


let channelsAndStamps = []

const main = () => {

  function sendData() {
     const Http = new XMLHttpRequest();
     const url = "http://localhost:3000/midi"
     Http.open("POST", url);
     Http.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
     Http.send(JSON.stringify(channelsAndStamps));

     Http.onreadystatechange = onsuccess; 
  }

  const onsuccess = (response) => {
    console.log(response);
  }
  
  
  navigator.requestMIDIAccess().then( access => {
    console.log(access.inputs);
    
    const devices = access.inputs.values();
    for (let device of devices ) {
      if (device.name == "OP-Z") {
        device.onmidimessage = onMidiMessage
        device.onstatechange = handleDeviceStateChange 
      }
    }
    
  }).catch(console.error);
  
  
  function onMidiMessage(message){
    console.log(message.data[0].toString())
    if ((ON_CHANNELS[message.data[0].toString()] != undefined) || (OFF_CHANNELS[message.data[0].toString()] != undefined)) {
      channelsAndStamps.push({"noteChannel": message.data[0], "timeStamp": event.timeStamp })
    }

  }

  // send data once opz is disconnected
  function handleDeviceStateChange(arg) {
    if(arg.currentTarget.state == "disconnected") {
      sendData();
    }
  }
  
}


const setListener = () => {
  document.getElementById("div").addEventListener("click", main)
}


window.onload = setListener;

</script>

<div id="div" style="width:100%;height:700px;background-color:cornflowerblue;">
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
    CLICK
  </div>
    