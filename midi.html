<!DOCTYPE html>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.0.13/Tone.min.js"></script>
<script> 


//use this to determine which chanel an input comes from 

//http://computermusicresource.com/MIDI.Commands.html?source=post_page---------------------------
const CHANNELS = {
    "144": "1",
    "145": "2",
    "146": "3",
    "147": "4",
    "148": "5",
    "149": "6",
    "150": "7",
    "151": "8",
    "152": "9",
    "153": "10",
    "154": "11",
    "155": "12",
    "156": "13",
    "157": "14",
    "158": "15",
    "159": "16"
}


let channelsAndStamps = []

const main = () => {

  function sendData() {
     const Http = new XMLHttpRequest();
     const url = "http://localhost:3000/midi"
     Http.open("POST", url);
     Http.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
     Http.send(JSON.stringify(channelsAndStamps));

     Http.onreadystatechange = onsuccess; 
  }

  const onsuccess = (response) => {
    console.log(response);
  }
  
  
  navigator.requestMIDIAccess().then( access => {
    console.log(access.inputs);
    
    const devices = access.inputs.values();
    for (let device of devices ) {
      if (device.name == "OP-Z") {
        device.onmidimessage = onMidiMessage
        device.onstatechange = handleDeviceStateChange 
      }
    }
    
  }).catch(console.error);
  
  
  function onMidiMessage(message){
    if(message.data[2] > 0) {
        noteOn(message)
    } else {
        // noteOff(message)
    }
    
  }

  function handleDeviceStateChange(arg) {
    if(arg.currentTarget.state == "disconnected") {
      //sendchannelsandstamps.push( to api
      sendData();
    }
  }

  function noteOn(message) {
        //inspect
        console.log("NOTE ON!: ");
        console.log(message);
        //what is the timestamp?
        console.log("Timestamp is: " + message.timeStamp);
        // debugger
        commitValue(message.timeStamp, CHANNELS[message.data[0].toString()])
  }

  function noteOff(message) {
        //inspect
        console.log("NOTE OFF!: " +  message);
        //what is the timestamp?
        console.log("Timestamp is: " + message.timeStamp);
  }

  //build up our video script 
  function commitValue(time, channel) {
      let pair = {} 
      pair[channel]=time
      channelsAndStamps.push(pair)
      console.log("CHANNELSANDSTAMPS") 
  }
  
}


const setListener = () => {
  document.getElementById("div").addEventListener("click", main)
}


window.onload = setListener;

</script>

<div id="div" style="width:100%;height:700px;background-color:red;">
    touch me 
  </div>
    