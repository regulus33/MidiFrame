<!DOCTYPE html>
<html>
<head>
<title>DAWNSOONS OPZ MultiTrack Recorder</title>
</head>

<style>
    body {
        color: #EFEFAE;
        background-color: #3A3A3A;
        font-family: 'Fira Mono', Monospace;
    }

    h3 {
        color: #005F5F;
    }

    a {
       color: #d75f5f;
    }

    strong {
        color: #87af87;
    }

    .slidecontainer {
        width: 100%;
    }

    .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 15px;
        border-radius: 5px;
        background: #d3d3d3;
        outline: none;x`
        opacity: 0.7;
        -webkit-transition: .2s;
        transition: opacity .2s;
    }

    .slider:hover {
        opacity: 1;
    }

    .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #d75f5f;
        cursor: pointer;
    }

    .slider::-moz-range-thumb {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        background: #d75f5f;
        cursor: pointer;
    }

    .form-label {
        color: #d75f5f; 
    }   

    progress#progress {
        background: white;
    }

</style>

<body>
    <h3>DAWNSOON'S MIDI SPLITI</h3>
    <a href="#" id="midiConsent">Click Here First Please</a>
    <br/>
    <br/>
    <strong>How to use this program:</strong>

    <p>given a project number and a track to be recorded, mute all tracks on all patterns in the given project that are not listed in the tracks to be recorded. </p>


    <span class="form-label">BAR COUNT:</span> <span id="patternCount"></span>
    <div class="slidecontainer">
        <input type="range" min="1" max="128" value="4" class="slider" id="patternCountRange">
    </div>
    <span class="form-label">PROJECT SLOT:</span> <span id="projectSlot"></span>
    <div class="slidecontainer">
        <input type="range" min="1" max="10" value="5" class="slider" id="projectSlotRange">
    </div>
    <a href="#" id="start">start</a>
    <br/>
    <br/>
    <br/>
    Recording progress:
    <progress id="progress" value="0" max="0"></progress>
    <br/>
    <br/>
    <fieldset>
        <br />
        <legend>Click the tracks you want to record:</legend>
        <input class= "tracks" type='checkbox' name='KICK' value='KICK'/><label for='message'>&nbspkick</label><br /><br />
        <input class= "tracks" type='checkbox' name='SNARE' value='SNARE'/><label for='message'>&nbspsnare</label><br /><br />
        <input class= "tracks" type='checkbox' name='HAT' value='HAT'/><label for='message'>&nbsphat</label><br /><br />
        <input class= "tracks" type='checkbox' name='SAMPLE' value='SAMPLE'/><label for='message'>&nbspsample</label><br /><br />
        <input class= "tracks" type='checkbox' name='BASS' value='BASS'/><label for='message'>&nbspbass</label><br /><br />
        <input class= "tracks" type='checkbox' name='LEAD' value='LEAD'/><label for='message'>&nbsplead</label><br /><br />
        <input class= "tracks" type='checkbox' name='ARP' value='ARP'/><label for='message'>&nbsparp</label><br /><br />
        <input class= "tracks" type='checkbox' name='CHORD' value='CHORD'/><label for='message'>&nbspchord</label><br /><br />
        <input class= "tracks" type='checkbox' name='EFFECT_1' value='EFFECT_1'/><label for='message'>&nbspeffect 1</label><br /><br />
        <input class= "tracks" type='checkbox' name='EFFECT_2' value='EFFECT_2'/><label for='message'>&nbspeffect 2</label><br /><br />
    </fieldset>

    <br/>
    <br/>
    <br/>
</body>
<script>
    //////////////////////
    // GLOBAL VARIABLES//
    ////////////////////
    const CLOCK_SIGNALS_IN_1_BAR = 96
    const BEATS_IN_1_BAR = 4 
    let deviceId = 0
    let clockCount = 0 
    let clockSignalsBeforeDone = 0
    let selectedProject = 0 
    let recording = false 
    let midiAccess = {}
    let tracksToRecord = []

    const PROJECTS_TO_CODES = {
        10: 185,
        9: 184,
        8: 183,
        7: 182,
        6: 181,
        5: 180,
        4: 179,
        3: 178,
        2: 177,
        1: 176
    }

    const DELAY = 1000 

    const MUTE_COMMANDS = {
        TAPE: [186, 53, 1],
        EFFECT_2: [185, 53, 1],
        EFFECT_1: [184, 53, 1],
        CHORD: [183, 53, 1],
        ARP: [182, 53, 1],
        LEAD: [181, 53, 1],
        BASS: [180, 53, 1],
        SAMPLE: [179, 53, 1],
        HAT: [178, 53, 1],
        SNARE: [177, 53, 1],
        KICK: [176, 53, 1]
    }
    //MUTE GROUPS ARENT AS GRANULAR 
    // const MUTE_GROUPS = {
    //     kick:   [128, 54, 0],
    //     snare:  [128, 56, 0],
    //     hat:    [128, 58, 0],
    //     sample: [128, 61, 0],
    //     bass:   [128, 63, 0],
    //     lead:   [128, 66, 0],
    //     arp:    [128, 68, 0],
    //     chord:  [128, 70, 0],
    //     miscA:  [128, 73, 0],
    //     miscB:  [128, 75, 0],
    // }
  
    const calcClockSignalsBeforeDone = (barCount) => {
        return CLOCK_SIGNALS_IN_1_BAR * barCount
    }
 
    /////////////////////
    //   sliders      //
    ///////////////////

    const patternCountSlider = document.getElementById("patternCountRange");
    const patternCountSliderOutput = document.getElementById("patternCount");
    const progressBar = document.getElementById("progress")
    patternCountSliderOutput.innerHTML = patternCountSlider.value;
    progressBar.max = calcClockSignalsBeforeDone(patternCountSlider.value)

    patternCountSlider.oninput = () => {
        const totalBars = patternCountSlider.value
        patternCountSliderOutput.innerHTML = totalBars
        clockSignalsBeforeDone = calcClockSignalsBeforeDone(totalBars)
        progressBar.max = clockSignalsBeforeDone
    }

    /////////project sliders 
    const projectSlotSlider = document.getElementById("projectSlotRange");
    const projectSlotSliderOutput = document.getElementById("projectSlot");
    projectSlotSliderOutput.innerHTML = projectSlotSlider.value;
    selectedProject = projectSlotSlider.value 

    projectSlotSlider.oninput = () => {
        const projectSlotValue = projectSlotSlider.value
        projectSlotSliderOutput.innerHTML = projectSlotValue
        selectedProject = projectSlotValue
    }


    const midiConsent = (event) => {
        console.log('requesting to midi access')
        request()
    } 

    async function cycleMidi() {
        //fill the array if it isnt full yet, first time 
        if(tracksToRecord.length === 0) {
           assignRecordTracks()
        }

        let currentTrackToRecord = tracksToRecord.pop() 
       //iterate through every patthern an mute all but selected
       for(let i = 0; i < 15; i++) {
            //go through each pattern and mute tracks
            await sleep(DELAY) 
            sendMessage([PROJECTS_TO_CODES[selectedProject],103,i])
            //mute all but current 
            Object.keys(MUTE_COMMANDS).forEach((trackName) => {
                if( trackName != currentTrackToRecord ) {
                    sendMuteMessages(trackName)
                }
            })

       } 
        //all  mutes have been applied, start at pattern 0 
        // sendMessage([250])
        // recording = true 
        
    }

    async function sendMuteMessages(trackName){
        let muteMessage = MUTE_COMMANDS[trackName]
        console.log("sending: " + muteMessage )
        await sleep(DELAY)
        sendMessage(muteMessage)
    }

    const assignRecordTracks = () => {
        const tracks = document.getElementsByClassName("tracks")

        for(let i = 0; i < tracks.length; i++) {
            let element = tracks[i]
            if(element.checked) {
                debugger 
                tracksToRecord.push(element.value)
            } 
        }
      
        // these and then store them somewhere than iterate through that 
        // once user hits start 
        // then record mono and if you can do 2 channels record each chanel of each track 
    }


    const request = () => {
        return navigator.requestMIDIAccess( {sysex: true }).then( access => {
            midiAccess = access
            const inputPorts = access.inputs.values();
            const outputPorts = access.outputs.values();
            for (let out of outputPorts) {
                deviceId = out.id 
            }
            for (let device of inputPorts ) {
                if (device.name == "OP-Z") {
                    console.log(device.name + " connected")
                    device.onmidimessage = onMidiMessage 
                    // sendMessage("nothing")
                } else {
                    alert("Can't find an OP-Z :( Make Sure Your OP-Z is plugged into to the usb port on your device.")
                }
            }
        }).catch(console.error);
    }

    const onMidiMessage = (message) => {
        //IF THIS IS THE CLOCK SIGNAL AND WE ARE IN RECORDING MODE 
        if(recording && message.data[0] == 248) {
            //IF WE HAVE REACHED THE END OF THE PROJECT
            if(clockCount > 0 && clockCount == clockSignalsBeforeDone){
                //stop op-z 
                alert('length finished')
                //if there are stil tracks to record we will recall cycleMidi()
                if(tracksToRecord.length === 0) {
                    alert('recording is done')
                    sendMessage([252])
                } else {
                    cycleMidi()
                }
            } else {
                clockCount += 1 
                progressBar.value = clockCount
            }
        }
    }

    const sendMessage = (message) => { 
        const output = midiAccess.outputs.get(deviceId)
        output.send(message)
    }

    const sleep = (ms) => {
        return new Promise(resolve => setTimeout(resolve, ms))
    }

    document.getElementById('midiConsent').onclick = midiConsent 
    // document.getElementById('start').onclick = test
    document.getElementById('start').onclick = cycleMidi 

    //////////////////////////////////////


</script>
</html>